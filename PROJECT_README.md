# コアクラス画像分類・整理アプリ

AI技術を使用して建設工事の杭・境界標識の画像を自動分類し、フォルダ別に整理するGUIアプリケーションです。

## 🚀 主な機能

- **多クラス自動分類**: 最大12クラスの杭・境界標識に自動分類（4コアクラス + 8拡張クラス）
- **動的クラス選択**: 必要なクラスのみを選択して処理可能
- **高速バッチ処理**: 並列処理とバッチ最適化による大量画像の高速処理
- **リアルタイム処理**: 推論と同時にファイル移動を実行
- **ファイル整理**: 分類結果に基づいてフォルダ分けとリネーム
- **信頼度設定**: 分類精度の閾値を調整可能（0.1-1.0）
- **プレビュー機能**: 処理前に分類結果を確認
- **処理統計**: 分類結果の詳細レポートとリソース監視
- **低信頼度ファイル管理**: 閾値未満のファイルを専用フォルダに分離

## 📋 必要な環境

- **Python**: 3.8以上
- **OS**: Windows 10/11
- **メモリ**: 4GB以上推奨（8GB以上でより高速）
- **ストレージ**: 2GB以上の空き容量
- **GPU**: オプション（CUDA対応GPUがあれば高速化）

## 🔧 セットアップ方法

### 1. プロジェクトファイルの準備
以下のファイルとフォルダを新しいフォルダにコピーしてください：

```
your-project-folder/
├── core_classifier_organizer.py    # メインアプリケーション
├── config.json                     # 設定ファイル
├── requirements.txt                # Python依存関係
├── PROJECT_README.md               # このファイル
└── models/                         # 訓練済みモデルフォルダ
    ├── all_pile_classifier.h5      # 12クラス対応メインモデル
    ├── all_pile_model_info.json    # モデル設定情報
    ├── pile_classifier.h5          # コア4クラスモデル（フォールバック）
    └── model_info.json             # 基本モデル情報
```

### 2. Python環境のセットアップ

#### PowerShellまたはコマンドプロンプトで実行：

```powershell
# 仮想環境作成
python -m venv .venv

# 仮想環境有効化（PowerShell）
.venv\Scripts\Activate.ps1

# 仮想環境有効化（コマンドプロンプト）
# .venv\Scripts\activate.bat

# 依存関係インストール
pip install -r requirements.txt
```

### 3. アプリケーション起動

```powershell
# 仮想環境が有効化されていることを確認
python core_classifier_organizer.py
```

## 📖 使用方法

### 基本操作
1. **アプリケーション起動**後、GUI画面が表示されます
2. **分類対象フォルダ**で処理したい画像があるフォルダを選択
3. **整理先フォルダ**で分類結果を保存するフォルダを選択
4. **分類対象クラス選択**で処理したいクラスを選択：
   - **全選択**: 12クラス全て
   - **コア4クラス**: 基本的な4クラスのみ
   - **個別選択**: 必要なクラスのみチェック
5. **信頼度閾値**を調整（デフォルト: 0.1、推奨: 0.7-0.8）
6. **プレビュー**ボタンで動作確認（推奨）
7. **分類・整理実行**ボタンで処理開始

### 対応画像形式
- `.jpg`, `.jpeg`
- `.png`  
- `.bmp`
- `.tiff`

### 分類カテゴリ（12クラス対応）

#### コアクラス（4種類）
- **plastic**: プラスチック杭 (ファイル名プレフィックス: P)
- **plate**: プレート (ファイル名プレフィックス: PL)  
- **byou**: 金属鋲 (ファイル名プレフィックス: B)
- **concrete**: コンクリート杭 (ファイル名プレフィックス: C)

#### 拡張クラス（8種類）
- **traverse**: トラバース点 (ファイル名プレフィックス: T)
- **kokudo**: 国土標識 (ファイル名プレフィックス: KD)
- **gaiku_sankaku**: 街区三角点 (ファイル名プレフィックス: GS)
- **gaiku_setsu**: 街区節点 (ファイル名プレフィックス: GT)
- **gaiku_takaku**: 街区多角点 (ファイル名プレフィックス: GH)
- **gaiku_hojo**: 街区補助点 (ファイル名プレフィックス: GK)
- **traverse_in**: 内部トラバース (ファイル名プレフィックス: TI)
- **kagoshima_in**: 鹿児島内部点 (ファイル名プレフィックス: KI)

## ⚙️ 設定オプション

### 処理オプション
- **信頼度閾値**: 0.1-1.0（高い値ほど厳密な分類）
- **バックアップ作成**: 処理前に元画像のバックアップを自動作成
- **ファイル名プレフィックス**: 杭種コードの自動追加
- **コピーモード**: 元ファイルを残してコピーで処理
- **低信頼度ファイル用フォルダ**: 閾値未満のファイルを専用フォルダに分離

### 最適化オプション
- **バッチ処理で高速化**: 並列バッチ処理による高速化（推奨：ON）
- **並列前処理で高速化**: 複数スレッドによる画像前処理（推奨：ON）

### 設定ファイル（config.json）
アプリケーションの詳細設定は `config.json` で調整可能：

```json
{
  "model_settings": {
    "confidence_threshold": 0.7,
    "batch_size": 64,
    "image_size": [320, 320]
  },
  "processing_settings": {
    "supported_extensions": [".jpg", ".jpeg", ".png", ".bmp", ".tiff"],
    "backup_enabled": true,
    "max_file_size_mb": 30
  }
}
```

## 🔍 トラブルシューティング

### よくある問題

**Q: "TensorFlowが利用できません" エラー**
A: 以下を順番に試してください：
```powershell
# 仮想環境の再作成
rm -rf .venv
python -m venv .venv
.venv\Scripts\Activate.ps1
pip install --upgrade pip
pip install -r requirements.txt
```

**Q: モデルファイルが見つからない**  
A: modelsフォルダに以下のファイルがあることを確認：
   - `all_pile_classifier.h5` (12クラス対応)
   - `all_pile_model_info.json`
   - `pile_classifier.h5` (フォールバック用)
   - `model_info.json`

**Q: 画像が処理されない**
A: 以下を確認してください：
   - 対応形式の画像ファイルが入力フォルダにある
   - 分類対象クラスが少なくとも1つ選択されている
   - ファイルサイズが30MB以下（設定変更可能）

**Q: 分類精度が低い**
A: 以下を試してください：
   - 信頼度閾値を0.6-0.7に下げる
   - 適切なクラスを選択する（不要なクラスは除外）
   - より多くの訓練データでモデルを再訓練

**Q: 処理が遅い**
A: 以下で高速化できます：
   - バッチ処理オプションを有効化
   - 並列前処理オプションを有効化
   - 不要なクラスを除外して選択クラス数を削減
   - GPU環境の使用（CUDA対応）

### ログの確認
アプリ下部の「処理ログ」エリアで詳細な実行状況を確認できます。エラーが発生した場合は、このログ内容をコピーしてサポートに連絡してください。

## 📂 プロジェクト構造

```
project/
├── core_classifier_organizer.py    # メインアプリケーション
├── config.json                     # 設定ファイル
├── requirements.txt                # 依存関係定義
├── PROJECT_README.md               # プロジェクト説明
├── .venv/                          # Python仮想環境（自動作成）
└── models/                         # AIモデル
    ├── all_pile_classifier.h5      # 12クラス対応訓練済みモデル
    ├── all_pile_model_info.json    # 12クラスモデル設定
    ├── pile_classifier.h5          # 4クラス訓練済みモデル（フォールバック）
    └── model_info.json             # 4クラスモデル設定
```

## 🛠️ 技術仕様

### AIモデル
- **フレームワーク**: TensorFlow/Keras
- **ベースアーキテクチャ**: MobileNetV2（転移学習）
- **入力サイズ**: 320x320 RGB
- **出力**: 4クラスまたは12クラス分類
- **モデルファイル**: HDF5形式（.h5）

### パフォーマンス最適化
- **バッチ処理**: 動的バッチサイズ決定（メモリ・GPU考慮）
- **並列処理**: マルチスレッド前処理（最大4ワーカー）
- **リアルタイム処理**: 推論と同時ファイル移動
- **メモリ管理**: バッチ完了後の自動メモリクリア
- **リソース監視**: CPU・メモリ・GPU使用率の実時間監視

### GUI
- **フレームワーク**: Python tkinter
- **ウィンドウサイズ**: 900x700（リサイズ可能）
- **リアルタイム更新**: プログレス表示・統計・ログ

### 設定・ログ
- **設定形式**: JSON
- **ログ出力**: GUI内表示 + 詳細ログ
- **統計情報**: 処理件数・成功率・エラー率・FPS

## 📊 パフォーマンス指標

### 処理速度（目安）
- **CPU処理**: 1-5 FPS（画像サイズ・CPUによる）
- **GPU処理**: 10-50 FPS（GPU性能による）
- **バッチ処理**: 通常の2-5倍高速

### システム要件
- **最小メモリ**: 4GB（バッチサイズ4）
- **推奨メモリ**: 8GB+（バッチサイズ16-32）
- **GPU メモリ**: 2GB+（GPU処理時）

## 📄 ライセンス

このプロジェクトは教育・研究目的で作成されています。商用利用については別途ご相談ください。

## 📞 サポート

問題が発生した場合は、以下の情報と合わせてお問い合わせください：
- 処理ログの内容
- 使用環境（Python版・OS・メモリ容量）
- エラーメッセージの完全なスクリーンショット
- 使用モデル情報（4クラス/12クラス）

---

*最終更新: 2025年10月6日*